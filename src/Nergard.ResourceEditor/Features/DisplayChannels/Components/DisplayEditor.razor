@using Nergard.ResourceEditor.Features.Shared.Constants
@using Nergard.ResourceEditor.Features.Shared.Models
@using Nergard.ResourceEditor.Features.DisplayChannels.Models
@inherits EditorComponentBase<DisplayTranslation>

<MudCard Elevation="2" Class="@(Translation.HasChanges ? "re-unsaved-indicator re-editor-enter" : "re-editor-enter")"
         Style="padding-bottom: 72px;">
    <MudCardHeader Class="re-card-header">
        <CardHeaderContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Devices" />
                <MudText Typo="Typo.h6">Display</MudText>
            </MudStack>
        </CardHeaderContent>
        <CardHeaderActions>
            @if (Translation.HasChanges)
            {
                <MudChip T="string" Color="Color.Warning" Size="Size.Small" Icon="@Icons.Material.Filled.Edit" Class="ma-0">
                    Unsaved
                </MudChip>
            }
        </CardHeaderActions>
    </MudCardHeader>

    <MudCardContent>
        @* Language Filter & Translate *@
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
            <LanguageFilter SelectedLanguageId="@SelectedLanguageId"
                            SelectedLanguageIdChanged="OnLanguageFilterChanged"
                            Languages="Languages" />
            <MudSpacer />
            @if (Options.Value.EnableAutomatedTranslation && IsTranslationAvailable)
            {
                <MudButton Variant="Variant.Outlined" Size="Size.Small" Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.AutoFixHigh"
                           OnClick="TranslateMissingFieldsAsync"
                           Disabled="@IsTranslating">
                    @(IsTranslating ? "Translating..." : "Translate Missing")
                </MudButton>
            }
        </MudStack>

        @* Display Channels *@
        @if (Translation.Channels.Count > 0)
        {
            <div class="mb-6">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4" Style="padding-bottom: 8px; border-bottom: 1px solid var(--mud-palette-lines-default);">
                    <MudText Typo="Typo.h6">Display Channels (@Translation.Channels.Count)</MudText>
                    <MudSpacer />
                    <MudTooltip Text="@(_channelsExpanded ? "Collapse all" : "Expand all")">
                        <MudIconButton Icon="@(_channelsExpanded ? Icons.Material.Filled.UnfoldLess : Icons.Material.Filled.UnfoldMore)"
                                       Size="Size.Small"
                                       OnClick="ToggleChannelsExpanded" />
                    </MudTooltip>
                </MudStack>
                <MudExpansionPanels MultiExpansion="true" Elevation="0" Dense="true">
                    @foreach (var channel in Translation.Channels)
                    {
                        <MudExpansionPanel Expanded="@_channelsExpanded">
                            <TitleContent>
                                <div class="re-property-panel-header">
                                    <span class="re-property-panel-name">@channel.Key</span>
                                </div>
                            </TitleContent>
                            <ChildContent>
                                <MudGrid Spacing="3">
                                    @foreach (var lang in FilteredLanguages)
                                    {
                                        <MudItem xs="12" sm="@(IsSingleLanguage ? 12 : 6)" md="@(IsSingleLanguage ? 12 : 4)" lg="@(IsSingleLanguage ? 12 : 3)">
                                            <LocalizableTextField @bind-Value="channel.Value.Values[lang.Id]"
                                                                  Label="@lang.Name"
                                                                  LocalizationKey="@GetChannelKey(channel.Key)"
                                                                  Language="@lang.Id"
                                                                  ContentTypeName="Display"
                                                                  PropertyName="@channel.Key"
                                                                  SourceValue="@(channel.Value.Values.GetValueOrDefault(DefaultLanguageId, ""))"
                                                                  FieldType="TranslationFieldType.DisplayChannel"
                                                                  ShowTranslate="@(IsTranslationAvailable && lang.Id != DefaultLanguageId)" />
                                        </MudItem>
                                    }
                                </MudGrid>
                            </ChildContent>
                        </MudExpansionPanel>
                    }
                </MudExpansionPanels>
            </div>
        }

        @* Display Options *@
        @if (Translation.Options.Count > 0)
        {
            <div class="mb-6">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4" Style="padding-bottom: 8px; border-bottom: 1px solid var(--mud-palette-lines-default);">
                    <MudText Typo="Typo.h6">Display Options (@Translation.Options.Count)</MudText>
                    <MudSpacer />
                    <MudTooltip Text="@(_optionsExpanded ? "Collapse all" : "Expand all")">
                        <MudIconButton Icon="@(_optionsExpanded ? Icons.Material.Filled.UnfoldLess : Icons.Material.Filled.UnfoldMore)"
                                       Size="Size.Small"
                                       OnClick="ToggleOptionsExpanded" />
                    </MudTooltip>
                </MudStack>
                <MudExpansionPanels MultiExpansion="true" Elevation="0" Dense="true">
                    @foreach (var option in Translation.Options)
                    {
                        <MudExpansionPanel Expanded="@_optionsExpanded">
                            <TitleContent>
                                <div class="re-property-panel-header">
                                    <span class="re-property-panel-name">@option.Key</span>
                                </div>
                            </TitleContent>
                            <ChildContent>
                                <MudGrid Spacing="3">
                                    @foreach (var lang in FilteredLanguages)
                                    {
                                        <MudItem xs="12" sm="@(IsSingleLanguage ? 12 : 6)" md="@(IsSingleLanguage ? 12 : 4)" lg="@(IsSingleLanguage ? 12 : 3)">
                                            <LocalizableTextField @bind-Value="option.Value.Values[lang.Id]"
                                                                  Label="@lang.Name"
                                                                  LocalizationKey="@GetOptionKey(option.Key)"
                                                                  Language="@lang.Id"
                                                                  ContentTypeName="Display"
                                                                  PropertyName="@option.Key"
                                                                  SourceValue="@(option.Value.Values.GetValueOrDefault(DefaultLanguageId, ""))"
                                                                  FieldType="TranslationFieldType.DisplayOption"
                                                                  ShowTranslate="@(IsTranslationAvailable && lang.Id != DefaultLanguageId)" />
                                        </MudItem>
                                    }
                                </MudGrid>
                            </ChildContent>
                        </MudExpansionPanel>
                    }
                </MudExpansionPanels>
            </div>
        }

        @* Resolutions *@
        @if (Translation.Resolutions.Count > 0)
        {
            <div class="mb-6">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4" Style="padding-bottom: 8px; border-bottom: 1px solid var(--mud-palette-lines-default);">
                    <MudText Typo="Typo.h6">Resolutions (@Translation.Resolutions.Count)</MudText>
                    <MudSpacer />
                    <MudTooltip Text="@(_resolutionsExpanded ? "Collapse all" : "Expand all")">
                        <MudIconButton Icon="@(_resolutionsExpanded ? Icons.Material.Filled.UnfoldLess : Icons.Material.Filled.UnfoldMore)"
                                       Size="Size.Small"
                                       OnClick="ToggleResolutionsExpanded" />
                    </MudTooltip>
                </MudStack>
                <MudExpansionPanels MultiExpansion="true" Elevation="0" Dense="true">
                    @foreach (var resolution in Translation.Resolutions)
                    {
                        <MudExpansionPanel Expanded="@_resolutionsExpanded">
                            <TitleContent>
                                <div class="re-property-panel-header">
                                    <span class="re-property-panel-name">@resolution.Key</span>
                                </div>
                            </TitleContent>
                            <ChildContent>
                                <MudGrid Spacing="3">
                                    @foreach (var lang in FilteredLanguages)
                                    {
                                        <MudItem xs="12" sm="@(IsSingleLanguage ? 12 : 6)" md="@(IsSingleLanguage ? 12 : 4)" lg="@(IsSingleLanguage ? 12 : 3)">
                                            <LocalizableTextField @bind-Value="resolution.Value.Values[lang.Id]"
                                                                  Label="@lang.Name"
                                                                  LocalizationKey="@GetResolutionKey(resolution.Key)"
                                                                  Language="@lang.Id"
                                                                  ContentTypeName="Display"
                                                                  PropertyName="@resolution.Key"
                                                                  SourceValue="@(resolution.Value.Values.GetValueOrDefault(DefaultLanguageId, ""))"
                                                                  FieldType="TranslationFieldType.DisplayResolution"
                                                                  ShowTranslate="@(IsTranslationAvailable && lang.Id != DefaultLanguageId)" />
                                        </MudItem>
                                    }
                                </MudGrid>
                            </ChildContent>
                        </MudExpansionPanel>
                    }
                </MudExpansionPanels>
            </div>
        }
    </MudCardContent>
</MudCard>

<EditorActionBar HasChanges="@Translation.HasChanges"
                 IsSaving="@IsSaving"
                 EnableFileSaving="@Options.Value.EnableFileSaving"
                 OnSave="OnSave"
                 OnReset="OnReset" />
